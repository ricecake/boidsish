# This workflow builds Boidsish on multiple platforms and creates release artifacts.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: CMake on multiple platforms

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations.
      fail-fast: false

      # Build matrix for Windows and Linux
      # - Windows: MSVC compiler
      # - Linux: GCC compiler (primary release build)
      # Note: Clang builds run for CI but are not included in release artifacts
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, windows-latest]
        build_type: [Release]
        c_compiler: [gcc, clang, cl]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
            artifact_name: windows-x64
            artifact_ext: .exe
          - os: ubuntu-22.04
            c_compiler: gcc
            cpp_compiler: g++
            artifact_name: linux-x64-ubuntu22
            artifact_ext: ""
          - os: ubuntu-22.04
            c_compiler: clang
            cpp_compiler: clang++
            artifact_name: linux-x64-ubuntu22-clang
            artifact_ext: ""
          - os: ubuntu-24.04
            c_compiler: gcc
            cpp_compiler: g++
            artifact_name: linux-x64-ubuntu24
            artifact_ext: ""
          - os: ubuntu-24.04
            c_compiler: clang
            cpp_compiler: clang++
            artifact_name: linux-x64-ubuntu24-clang
            artifact_ext: ""
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: ubuntu-22.04
            c_compiler: cl
          - os: ubuntu-24.04
            c_compiler: cl

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies (Ubuntu)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -y mesa-common-dev libgl1-mesa-dev libglu1-mesa-dev libglfw3-dev libglew-dev libglm-dev libassimp-dev libgtest-dev zlib1g-dev libgl-dev libglx-dev libopengl-dev xvfb imagemagick x11-utils x11-apps

    - name: Install Dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        vcpkg install glew:x64-windows glfw3:x64-windows glm:x64-windows assimp:x64-windows gtest:x64-windows zlib:x64-windows

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        WORKSPACE_DIR="${{ github.workspace }}"
        WORKSPACE_DIR="${WORKSPACE_DIR//\\//}"
        echo "build-output-dir=$WORKSPACE_DIR/build" >> "$GITHUB_OUTPUT"
        echo "workspace-dir=$WORKSPACE_DIR" >> "$GITHUB_OUTPUT"

    - name: Configure CMake
      shell: bash
      run: |
        CMAKE_ARGS=(
          -B "${{ steps.strings.outputs.build-output-dir }}"
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -S "${{ steps.strings.outputs.workspace-dir }}"
        )
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          VCPKG_TOOLCHAIN="${VCPKG_INSTALLATION_ROOT//\\//}/scripts/buildsystems/vcpkg.cmake"
          CMAKE_ARGS+=("-DCMAKE_TOOLCHAIN_FILE=$VCPKG_TOOLCHAIN")
        fi
        cmake "${CMAKE_ARGS[@]}"

    - name: Build
      run: cmake --build "${{ steps.strings.outputs.build-output-dir }}" --config ${{ matrix.build_type }}

    - name: Test
      working-directory: "${{ steps.strings.outputs.build-output-dir }}"
      shell: bash
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-22.04" || "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
          xvfb-run ctest --build-config ${{ matrix.build_type }}
        else
          ctest --build-config ${{ matrix.build_type }}
        fi

    - name: Prepare Release Artifacts (Linux)
      if: startsWith(matrix.os, 'ubuntu') && matrix.c_compiler == 'gcc'
      shell: bash
      run: |
        mkdir -p release/boidsish-${{ matrix.artifact_name }}
        # Copy all example executables
        find "${{ steps.strings.outputs.build-output-dir }}" -maxdepth 1 -type f -executable ! -name "test_*" ! -name "*.a" -exec cp {} release/boidsish-${{ matrix.artifact_name }}/ \;
        # Copy assets
        cp -r "${{ steps.strings.outputs.build-output-dir }}/assets" release/boidsish-${{ matrix.artifact_name }}/
        # Copy shaders
        cp -r "${{ steps.strings.outputs.workspace-dir }}/shaders" release/boidsish-${{ matrix.artifact_name }}/
        # Copy README and documentation
        cp "${{ steps.strings.outputs.workspace-dir }}/README.md" release/boidsish-${{ matrix.artifact_name }}/ || true
        # Create archive
        cd release
        tar -czvf boidsish-${{ matrix.artifact_name }}.tar.gz boidsish-${{ matrix.artifact_name }}

    - name: Prepare Release Artifacts (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release/boidsish-${{ matrix.artifact_name }}
        # Copy executables from Release folder (MSVC puts them in a Release subdirectory)
        $buildDir = "${{ steps.strings.outputs.build-output-dir }}"
        $releaseDir = Join-Path $buildDir "Release"
        if (Test-Path $releaseDir) {
          Get-ChildItem -Path $releaseDir -Filter "*.exe" | Where-Object { $_.Name -notlike "test_*" } | Copy-Item -Destination "release/boidsish-${{ matrix.artifact_name }}/"
        } else {
          Get-ChildItem -Path $buildDir -Filter "*.exe" | Where-Object { $_.Name -notlike "test_*" } | Copy-Item -Destination "release/boidsish-${{ matrix.artifact_name }}/"
        }
        # Copy required DLLs from vcpkg
        $vcpkgBin = "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows/bin"
        if (Test-Path $vcpkgBin) {
          Copy-Item "$vcpkgBin/*.dll" -Destination "release/boidsish-${{ matrix.artifact_name }}/" -ErrorAction SilentlyContinue
        }
        # Copy assets
        Copy-Item -Path "$buildDir/assets" -Destination "release/boidsish-${{ matrix.artifact_name }}/" -Recurse
        # Copy shaders
        Copy-Item -Path "${{ steps.strings.outputs.workspace-dir }}/shaders" -Destination "release/boidsish-${{ matrix.artifact_name }}/" -Recurse
        # Copy README
        Copy-Item -Path "${{ steps.strings.outputs.workspace-dir }}/README.md" -Destination "release/boidsish-${{ matrix.artifact_name }}/" -ErrorAction SilentlyContinue
        # Create ZIP archive
        Compress-Archive -Path "release/boidsish-${{ matrix.artifact_name }}" -DestinationPath "release/boidsish-${{ matrix.artifact_name }}.zip"

    - name: Upload Build Artifacts (Linux GCC)
      if: startsWith(matrix.os, 'ubuntu') && matrix.c_compiler == 'gcc'
      uses: actions/upload-artifact@v4
      with:
        name: boidsish-${{ matrix.artifact_name }}
        path: release/boidsish-${{ matrix.artifact_name }}.tar.gz
        retention-days: 30

    - name: Upload Build Artifacts (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: boidsish-${{ matrix.artifact_name }}
        path: release/boidsish-${{ matrix.artifact_name }}.zip
        retention-days: 30

  # Create a GitHub Release when a tag is pushed
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -R artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Boidsish ${{ github.ref_name }}
        body: |
          ## Boidsish ${{ github.ref_name }}

          ### Downloads

          | Platform | Archive |
          |----------|---------|
          | Windows (x64) | `boidsish-windows-x64.zip` |
          | Linux Ubuntu 22.04 (x64) | `boidsish-linux-x64-ubuntu22.tar.gz` |
          | Linux Ubuntu 24.04 (x64) | `boidsish-linux-x64-ubuntu24.tar.gz` |

          ### Installation

          1. Download the appropriate archive for your platform
          2. Extract the archive to your desired location
          3. Run any of the example executables from the extracted directory

          ### Requirements

          **Windows:**
          - Visual C++ Redistributable 2022 or later

          **Linux:**
          - OpenGL 4.2+ compatible graphics driver
          - Install dependencies: `sudo apt-get install libglfw3 libglew2.2 libassimp5`

          ### What's Included

          - All example executables demonstrating various features
          - Required assets (models, textures)
          - Shader files
          - Documentation

        draft: false
        prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
        files: |
          artifacts/**/*.tar.gz
          artifacts/**/*.zip
        fail_on_unmatched_files: false
        generate_release_notes: true
